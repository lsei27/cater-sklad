generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  event_manager
  chef
  warehouse
}

enum LedgerReason {
  purchase
  writeoff
  audit_adjustment
  breakage
  missing
  manual
}

enum EventStatus {
  DRAFT
  READY_FOR_WAREHOUSE
  SENT_TO_WAREHOUSE
  ISSUED
  CLOSED
  CANCELLED
}

enum ReservationState {
  draft
  confirmed
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         Role
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  createdEvents  Event[]          @relation("event_created_by")
  ledgerEntries  InventoryLedger[]
  exports        EventExport[]
  issues         EventIssue[]
  returns        EventReturn[]
  auditEntries   AuditLog[]
  createdReservations EventReservation[]


  @@map("users")
}

model Category {
  id        String    @id @default(uuid()) @db.Uuid
  name      String
  parentId  String?   @map("parent_id") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  parent   Category?  @relation("category_parent", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("category_parent")
  activeRoles RoleCategoryAccess[]
  items    InventoryItem[]

  @@unique([parentId, name])
  @@index([parentId], map: "idx_cat_parent")
  @@map("categories")
}

model InventoryItem {
  id              String   @id @default(uuid()) @db.Uuid
  name            String
  categoryId      String   @map("category_id") @db.Uuid
  unit            String   @default("ks")
  imageUrl        String?  @map("image_url")
  active          Boolean  @default(true)
  returnDelayDays Int      @default(0) @map("return_delay_days")
  sku             String?  @unique
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  category     Category          @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  ledger       InventoryLedger[]
  reservations EventReservation[]
  issues       EventIssue[]
  returns      EventReturn[]

  @@index([categoryId])
  @@map("inventory_items")
}

model InventoryLedger {
  id              String       @id @default(uuid()) @db.Uuid
  inventoryItemId String       @map("inventory_item_id") @db.Uuid
  deltaQuantity   Int          @map("delta_quantity")
  reason          LedgerReason
  eventId         String?      @map("event_id") @db.Uuid
  note            String?
  createdById     String       @map("created_by") @db.Uuid
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)

  item      InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  event     Event?        @relation(fields: [eventId], references: [id], onDelete: SetNull)
  createdBy User          @relation(fields: [createdById], references: [id], onDelete: Restrict)

  @@index([inventoryItemId], map: "idx_ledger_item")
  @@map("inventory_ledger")
}

model Event {
  id                  String      @id @default(uuid()) @db.Uuid
  name                String
  location            String
  address             String?
  deliveryDatetime    DateTime    @map("delivery_datetime") @db.Timestamptz(6)
  pickupDatetime      DateTime    @map("pickup_datetime") @db.Timestamptz(6)
  eventDate           DateTime?   @map("event_date") @db.Timestamptz(6)
  status              EventStatus @default(DRAFT)
  exportNeedsRevision Boolean     @default(false) @map("export_needs_revision")
  chefConfirmedAt     DateTime?   @map("chef_confirmed_at") @db.Timestamptz(6)
  createdById         String      @map("created_by") @db.Uuid
  createdAt           DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)

  createdBy    User               @relation("event_created_by", fields: [createdById], references: [id], onDelete: Restrict)
  reservations EventReservation[]
  exports      EventExport[]
  issues       EventIssue[]
  returns      EventReturn[]
  ledger       InventoryLedger[]

  @@index([deliveryDatetime], map: "idx_events_delivery")
  @@index([pickupDatetime], map: "idx_events_pickup")
  @@map("events")
}

model EventReservation {
  id              String           @id @default(uuid()) @db.Uuid
  eventId         String           @map("event_id") @db.Uuid
  inventoryItemId String           @map("inventory_item_id") @db.Uuid
  reservedQuantity Int             @map("reserved_quantity")
  state           ReservationState @default(draft)
  expiresAt       DateTime?        @map("expires_at") @db.Timestamptz(6)

  event Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  item  InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  createdById String? @map("created_by") @db.Uuid
  createdBy   User?   @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([eventId, inventoryItemId])
  @@index([eventId, inventoryItemId], map: "idx_res_event_item")
  @@index([inventoryItemId], map: "idx_res_item")
  @@index([state, expiresAt], map: "idx_res_state_exp")
  @@map("event_reservations")
}

model RoleCategoryAccess {
  id         String   @id @default(uuid()) @db.Uuid
  role       Role
  categoryId String   @map("category_id") @db.Uuid
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([role, categoryId])
  @@map("role_category_access")
}

model EventExport {
  id           String   @id @default(uuid()) @db.Uuid
  eventId      String   @map("event_id") @db.Uuid
  version      Int
  exportedAt   DateTime @map("exported_at") @db.Timestamptz(6)
  exportedById String   @map("exported_by") @db.Uuid
  snapshotJson Json     @map("snapshot_json")
  pdfPath      String?  @map("pdf_path")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  event      Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  exportedBy User  @relation(fields: [exportedById], references: [id], onDelete: Restrict)

  @@unique([eventId, version])
  @@map("event_exports")
}

model EventIssue {
  id             String   @id @default(uuid()) @db.Uuid
  eventId        String   @map("event_id") @db.Uuid
  inventoryItemId String  @map("inventory_item_id") @db.Uuid
  issuedQuantity Int      @map("issued_quantity")
  issuedById     String   @map("issued_by") @db.Uuid
  issuedAt       DateTime @default(now()) @map("issued_at") @db.Timestamptz(6)
  idempotencyKey String   @unique @map("idempotency_key")

  event    Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  item     InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  issuedBy User          @relation(fields: [issuedById], references: [id], onDelete: Restrict)

  @@map("event_issues")
}

model EventReturn {
  id              String   @id @default(uuid()) @db.Uuid
  eventId         String   @map("event_id") @db.Uuid
  inventoryItemId String   @map("inventory_item_id") @db.Uuid
  returnedQuantity Int     @map("returned_quantity")
  brokenQuantity  Int      @default(0) @map("broken_quantity")
  returnedById    String   @map("returned_by") @db.Uuid
  returnedAt      DateTime @default(now()) @map("returned_at") @db.Timestamptz(6)
  idempotencyKey  String   @unique @map("idempotency_key")

  event      Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  item       InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  returnedBy User          @relation(fields: [returnedById], references: [id], onDelete: Restrict)

  @@map("event_returns")
}

model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  actorUserId String   @map("actor_user_id") @db.Uuid
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id") @db.Uuid
  action      String
  diffJson    Json?    @map("diff_json")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  actor User @relation(fields: [actorUserId], references: [id], onDelete: Restrict)

  @@index([entityType, entityId])
  @@map("audit_log")
}
